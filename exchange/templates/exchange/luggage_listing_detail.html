{% extends "allauth/layouts/base.html" %}
{% load i18n humanize %}

{% block head_title %}{{ listing.title }}{% endblock %}

{% block content %}
<main class="container py-5">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-4">
    <div>
      <h1 class="fw-bold mb-1">{{ listing.title }}</h1>
      <p class="text-muted mb-0">{{ listing.departure_city }} → {{ listing.arrival_city }} · {% blocktrans %}available until{% endblocktrans %} {{ listing.available_until }}</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'luggage_marketplace' %}" class="btn btn-outline-secondary">{% translate 'Back to Marketplace' %}</a>
      {% if user == listing.seller %}
      <a href="{% url 'luggage_my_listings' %}" class="btn btn-primary">{% translate 'My Listings' %}</a>
      {% endif %}
    </div>
  </div>

  <div class="alert alert-light border d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2" role="alert">
    <span>{% translate 'Share this listing in your Telegram/Facebook groups:' %}</span>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer" href="https://t.me/share/url?url={{ request.build_absolute_uri|urlencode }}&text={{ listing.title|urlencode }}">Telegram</a>
      <a class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}">Facebook</a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6"><strong>{% translate 'Price per kg' %}:</strong> {{ listing.price_per_kg|intcomma }}</div>
            <div class="col-md-6"><strong>{% translate 'Pickup in Tokyo' %}:</strong> {{ listing.pickup_location_tokyo }}</div>
            <div class="col-12"><strong>{% translate 'Delivery options' %}:</strong> {{ listing.delivery_options|default:_('Not specified') }}</div>
            <div class="col-md-6"><strong>{% translate 'Allowed items' %}:</strong><br>{{ listing.allowed_items|linebreaks }}</div>
            <div class="col-md-6"><strong>{% translate 'Not allowed items' %}:</strong><br>{{ listing.prohibited_items|linebreaks }}</div>
            {% if listing.description %}
            <div class="col-12"><strong>{% translate 'Extra details' %}:</strong><br>{{ listing.description|linebreaks }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      {% if user == listing.seller %}
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light"><strong>{% translate 'Manage Reservations' %}</strong></div>
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th>{% translate 'Buyer' %}</th>
                <th>{% translate 'Kg' %}</th>
                <th>{% translate 'Contact' %}</th>
                <th>{% translate 'Status' %}</th>
                <th>{% translate 'Actions' %}</th>
              </tr>
            </thead>
            <tbody>
              {% for reservation in reservations %}
              <tr>
                <td>{{ reservation.buyer.username }}</td>
                <td>{{ reservation.kg_requested|floatformat:2 }}</td>
                <td>{{ reservation.contact_handle|default:'-' }}</td>
                <td>
                  <span class="badge {% if reservation.status == 'reserved' %}text-bg-success{% elif reservation.status == 'pending' %}text-bg-warning{% else %}text-bg-secondary{% endif %}">
                    {{ reservation.get_status_display }}
                  </span>
                </td>
                <td>
                  <form method="post" action="{% url 'luggage_reservation_status' reservation_id=reservation.id %}" class="d-flex gap-2">
                    {% csrf_token %}
                    <select name="status" class="form-select form-select-sm">
                      <option value="pending" {% if reservation.status == 'pending' %}selected{% endif %}>{% translate 'Pending' %}</option>
                      <option value="reserved" {% if reservation.status == 'reserved' %}selected{% endif %}>{% translate 'Reserved' %}</option>
                      <option value="cancelled" {% if reservation.status == 'cancelled' %}selected{% endif %}>{% translate 'Cancelled' %}</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">{% translate 'Update' %}</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-4">{% translate 'No reservations yet.' %}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="col-lg-5">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">{% translate 'Storage Status' %}</h2>
          <div class="d-flex justify-content-between small mb-1">
            <span>{% translate 'Committed / Total' %}</span>
            <span>{{ listing.committed_kg|floatformat:2 }}kg / {{ listing.total_kg|floatformat:2 }}kg</span>
          </div>
          <div class="progress mb-2" role="progressbar" aria-label="Storage usage">
            <div class="progress-bar" style="width: {% widthratio listing.committed_kg listing.total_kg 100 %}%"></div>
          </div>
          <div class="small mb-1"><strong>{% translate 'Reserved (confirmed)' %}:</strong> {{ listing.reserved_kg|floatformat:2 }}kg</div>
          <div class="small"><strong>{% translate 'Remaining' %}:</strong> {{ listing.remaining_kg|floatformat:2 }}kg</div>
        </div>
      </div>

      {% if user.is_authenticated %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">{% translate 'Telegram Notifications' %}</h2>
          {% if telegram_is_linked %}
          <form method="post" action="{% url 'luggage_telegram_notify_toggle' listing_id=listing.id %}" class="row g-2">
            {% csrf_token %}
            <div class="col-12 form-check">
              <input class="form-check-input" type="checkbox" id="sub_active" name="is_active" {% if telegram_subscription and telegram_subscription.is_active %}checked{% endif %}>
              <label class="form-check-label" for="sub_active">{% translate 'Enable notifications for this listing' %}</label>
            </div>
            <div class="col-12 form-check">
              <input class="form-check-input" type="checkbox" id="sub_new" name="notify_on_new_reservation" {% if not telegram_subscription or telegram_subscription.notify_on_new_reservation %}checked{% endif %}>
              <label class="form-check-label" for="sub_new">{% translate 'New reservation created' %}</label>
            </div>
            <div class="col-12 form-check">
              <input class="form-check-input" type="checkbox" id="sub_status" name="notify_on_status_change" {% if not telegram_subscription or telegram_subscription.notify_on_status_change %}checked{% endif %}>
              <label class="form-check-label" for="sub_status">{% translate 'Reservation status changes' %}</label>
            </div>
            <div class="col-12 form-check">
              <input class="form-check-input" type="checkbox" id="sub_sold" name="notify_on_sold_out" {% if not telegram_subscription or telegram_subscription.notify_on_sold_out %}checked{% endif %}>
              <label class="form-check-label" for="sub_sold">{% translate 'Listing sold out' %}</label>
            </div>
            <div class="col-12 form-check">
              <input class="form-check-input" type="checkbox" id="sub_reopen" name="notify_on_reopened" {% if not telegram_subscription or telegram_subscription.notify_on_reopened %}checked{% endif %}>
              <label class="form-check-label" for="sub_reopen">{% translate 'Space becomes available again' %}</label>
            </div>
            <div class="col-12 d-grid gap-2">
              <button class="btn btn-outline-primary" type="submit">{% translate 'Save Notification Settings' %}</button>
              {% if telegram_subscription and telegram_subscription.is_active %}
              <button class="btn btn-outline-danger" type="submit" name="action" value="disable">{% translate 'Disable for this listing' %}</button>
              {% endif %}
              <a href="{% url 'luggage_notifications' %}" class="btn btn-outline-secondary">{% translate 'Manage All Subscriptions' %}</a>
            </div>
          </form>
          {% else %}
          <p class="small text-muted">{% translate 'Connect your Telegram first by opening the bot and sending /connect, then enable notifications for this listing.' %}</p>
          {% if telegram_link_url %}
          <a href="{{ telegram_link_url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary w-100">
            {% translate 'Open Telegram Bot' %}
          </a>
          {% endif %}
          {% endif %}
        </div>
      </div>

      {% if listing.is_sellable and user != listing.seller %}

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">{% translate 'Reserve Storage' %}</h2>
          <form method="post" action="{% url 'luggage_reserve' listing_id=listing.id %}" class="row g-3">
            {% csrf_token %}
            <div class="col-12">
              <label class="form-label" for="{{ reservation_form.kg_requested.id_for_label }}">{% translate 'How many kg?' %}</label>
              {{ reservation_form.kg_requested }}
            </div>
            <div class="col-12">
              <label class="form-label" for="{{ reservation_form.contact_handle.id_for_label }}">{% translate 'Your phone number (optional)' %}</label>
              {{ reservation_form.contact_handle }}
            </div>
            <div class="col-12">
              <label class="form-label" for="{{ reservation_form.note.id_for_label }}">{% translate 'Item notes' %}</label>
              {{ reservation_form.note }}
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-primary" type="submit">{% translate 'Reserve Slot' %}</button>
            </div>
          </form>
        </div>
      </div>
      {% else %}
      <div class="alert alert-secondary">{% blocktrans %}This listing is closed or fully booked.{% endblocktrans %}</div>
      {% endif %}
      {% elif not user.is_authenticated %}
      <div class="alert alert-info">{% blocktrans %}Please sign in to reserve storage.{% endblocktrans %}</div>
      {% endif %}
    </div>
  </div>
</main>
{% endblock %}
