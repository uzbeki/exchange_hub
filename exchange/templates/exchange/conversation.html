{% extends 'allauth/layouts/manage.html' %} {% block head_title %}Conversation{% endblock %} {% block content %}
{% block head_extra %}<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">{% endblock head_extra %}
<div class="container py-3">
  <div class="row">
    <!-- Chat List -->
    <div class="col-lg-4 col-12 mb-3 mb-lg-0">
      <!-- Search Bar -->
      <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Search chats..." />
        <span class="input-group-text"><i class="bi bi-search"></i></span>
      </div>
      <!-- Chat List Items -->
      <div class="list-group list-group-flush">
        {% for conv in conversations %}
          <!-- Active Chat Item -->
          <a href="{% url "conversation" conversation_id=conv.id %}" class="list-group-item list-group-item-action {% if conversation.id == conv.id %}active{% endif %}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <i class="bi bi-person-circle fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1 text-truncate">
                      {% if conv.participant1 == request.user %}
                          {{ conv.participant2.username }}
                      {% else %}
                          {{ conv.participant1.username }}
                      {% endif %}
                  </h6>
                    <small class="text-truncate {% if conversation.id == conv.id %}text-light{% else %}text-body-secondary{% endif %}">{{conv.last_message}}</small>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <small class="{% if conversation.id == conv.id %}text-light{% else %}text-body-secondary{% endif %} me-2">{{conv.last_message_timestamp|time}}</small>
                {% comment %} <span class="badge bg-primary rounded-pill">2</span> {% endcomment %}
                <span class="badge bg-primary rounded-pill {% if conv.unread_count == 0 %}d-none{% endif %}">{{conv.unread_count}}</span>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- Chat Window -->
    <div class="col-lg-8 col-12">
      <div class="card h-100">
        <!-- Chat Header -->
        <div class="card-header d-flex align-items-center">
          <i class="bi bi-person-circle fs-4 me-2"></i>
          <h5 class="mb-0">
            {% if conversation.participant1 == request.user %}
                {{ conversation.participant2.username }}
            {% else %}
                {{ conversation.participant1.username }}
            {% endif %}
            <small>({{conversation.request}})</small>
            {% if conversation.request.status == "completed" %}
              <span class="badge bg-success ms-2">Completed</span>
            {% endif %}
          </h5>
        </div>
        <!-- Chat Messages -->
        <div class="card-body" style="max-height: 400px; overflow-y: auto">
          <div class="chat-messages">
            {% for m in chat_messages %}
            <!-- Received Message -->
            <div class="mb-2 {% if m.sender == request.user %}d-flex justify-content-end{% endif %}">
                <div class="{% if m.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %} p-2 rounded" style="max-width: 70%">
                    <small class="{% if m.sender == request.user %}text-white{% else %}text-muted{% endif %}">{{ m.sender.username }} â€¢ {{ m.timestamp|time }}
                        {% if m.is_read %}<i class="bi bi-check2-all {% if m.sender == request.user %}text-white{% else %}text-muted{% endif %}"></i>{% endif %}
                    </small>
                    <p class="mb-0">{{ m.content }}</p>
                </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <!-- Message Input -->
        <div class="card-footer">
          <form class="d-flex" method="post">
            {% csrf_token %}
            {{ form.content }}
            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
