{% extends 'allauth/layouts/manage.html' %}
{% load static %}
{% block head_title %}Conversation{% endblock %} 
{% block head_extra %}<script defer src="{% static "exchange/js/conversation.js" %}"></script>{% endblock head_extra %}
{% block content %}
<svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="person-circle" viewBox="0 0 16 16">
    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
  </symbol>
  <symbol id="three-dots-vertical" viewBox="0 0 16 16">
    <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
  </symbol>
  <symbol id="trash" viewBox="0 0 16 16">
    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>  
  </symbol>
  <symbol id="person" viewBox="0 0 16 16">
    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/>
  </symbol>
  <symbol id="share" viewBox="0 0 16 16">
    <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5m-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"/>
  </symbol>
  <symbol id="ban" viewBox="0 0 16 16">
    <path d="M15 8a6.97 6.97 0 0 0-1.71-4.584l-9.874 9.875A7 7 0 0 0 15 8M2.71 12.584l9.874-9.875a7 7 0 0 0-9.874 9.874ZM16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0"/>
  </symbol>
  <symbol id="flag" viewBox="0 0 16 16">
    <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12 12 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A20 20 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a20 20 0 0 0 1.349-.476l.019-.007.004-.002h.001M14 1.221c-.22.078-.48.167-.766.255-.81.252-1.872.523-2.734.523-.886 0-1.592-.286-2.203-.534l-.008-.003C7.662 1.21 7.139 1 6.5 1c-.669 0-1.606.229-2.415.478A21 21 0 0 0 3 1.845v6.433c.22-.078.48-.167.766-.255C4.576 7.77 5.638 7.5 6.5 7.5c.847 0 1.548.28 2.158.525l.028.01C9.32 8.29 9.86 8.5 10.5 8.5c.668 0 1.606-.229 2.415-.478A21 21 0 0 0 14 7.655V1.222z"/>
  </symbol>
  <symbol id="bell" viewBox="0 0 16 16">
    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"/>
  </symbol>
  <symbol id="bell-slash" viewBox="0 0 16 16">
    <path d="M5.164 14H15c-.299-.199-.557-.553-.78-1-.9-1.8-1.22-5.12-1.22-6q0-.396-.06-.776l-.938.938c.02.708.157 2.154.457 3.58.161.767.377 1.566.663 2.258H6.164zm5.581-9.91a4 4 0 0 0-1.948-1.01L8 2.917l-.797.161A4 4 0 0 0 4 7c0 .628-.134 2.197-.459 3.742q-.075.358-.166.718l-1.653 1.653q.03-.055.059-.113C2.679 11.2 3 7.88 3 7c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0c.942.19 1.788.645 2.457 1.284zM10 15a2 2 0 1 1-4 0zm-9.375.625a.53.53 0 0 0 .75.75l14.75-14.75a.53.53 0 0 0-.75-.75z"/>
  </symbol>
  <symbol id="search" viewBox="0 0 16 16">
    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
  </symbol>
  <symbol id="check2-all" viewBox="0 0 16 16">
    <path d="M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0"/>
    <path d="m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708"/>  
  </symbol>
  <symbol id="send" viewBox="0 0 16 16">
    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
  </symbol>

</svg>
<div class="container py-3">
  <div class="row">
    <!-- Chat List -->
    <div class="col-lg-4 col-12 mb-3 mb-lg-0">
      <!-- Search Bar -->
      <div class="input-group mb-3">
        <input type="text" class="form-control" disabled placeholder="Search chats..." data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ðŸ”œ coming soon!" />
        <span class="input-group-text">
          <svg class="bi" width="16" height="16" fill="currentColor">
            <use xlink:href="#search"></use>
          </svg>
        </span>
      </div>
      <!-- Chat List Items -->
      <div class="list-group list-group-flush">
        {% for conv in conversations %}
          <!-- Active Chat Item -->
          <a href="{% url "conversation" conversation_id=conv.id %}" class="list-group-item list-group-item-action {% if conversation.id == conv.id %}active{% endif %}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex">
                <div class="flex-shrink-0 d-flex align-items-center">
                  <svg class="bi" width="36" height="36" fill="currentColor">
                    <use xlink:href="#person-circle"></use>
                  </svg>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1 text-truncate">
                      {% if conv.participant1 == request.user %}
                          {{ conv.participant2.username }}
                      {% else %}
                          {{ conv.participant1.username }}
                      {% endif %}
                  </h6>
                    <small class="text-truncate {% if conversation.id == conv.id %}text-light{% else %}text-body-secondary{% endif %}">{{conv.last_message}}</small>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <small class="{% if conversation.id == conv.id %}text-light{% else %}text-body-secondary{% endif %} me-2">{{conv.last_message_timestamp|time}}</small>
                {% comment %} <span class="badge bg-primary rounded-pill">2</span> {% endcomment %}
                <span class="badge bg-primary rounded-pill {% if conv.unread_count == 0 %}d-none{% endif %}">{{conv.unread_count}}</span>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>

   <!-- Chat Window -->
  <div class="col-lg-8 col-12">
    <div class="card h-100">
      <!-- Chat Header with Dropdown -->
      <div class="card-header d-flex align-items-center">
        <svg class="bi me-2 flex-shrink-0" width="28" height="28" fill="currentColor">
          <use xlink:href="#person-circle"></use>
        </svg>        
        <h5 class="mb-0">
          {% if conversation.participant1 == request.user %}
            {{ conversation.participant2.username }}
          {% else %}
            {{ conversation.participant1.username }}
          {% endif %}
          <small>({{ conversation.request }})</small>
          {% if conversation.request.status == "completed" %}
            <span class="badge bg-success ms-2">Completed</span>
          {% endif %}
        </h5>
        <!-- Dropdown for Chat Actions -->
        <div class="dropdown ms-auto">
          <button class="btn btn-link" type="button" id="chatActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Chat actions">
            <svg class="bi" width="20" height="20" fill="currentColor">
              <use xlink:href="#three-dots-vertical"></use>
            </svg>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatActionsDropdown">
            <li><button class="dropdown-item" type="button" id="deleteChatButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#trash"/>
              </svg>Delete this chat</button>
            </li>
            <li><button class="dropdown-item" type="button" id="shareContactButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#share"/>
              </svg>Share my contact</button>
            </li>
            <li data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ðŸ”œ coming soon!">
              <button class="dropdown-item" disabled type="button" id="blockUserButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#ban"/>
              </svg>Block this user</button>
            </li>
            <li data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ðŸ”œ coming soon!">
              <button class="dropdown-item" disabled type="button" id="reportUserButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#flag"/>
              </svg>Report this user</button>
            </li>
            <li data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ðŸ”œ coming soon!">
              <button class="dropdown-item" disabled type="button" id="muteNotificationsButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#bell-slash"/>
              </svg>Mute notifications</button>
            </li>
            <li data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ðŸ”œ coming soon!">
              <button class="dropdown-item" disabled type="button" id="unmuteNotificationsButton" data-id="{{ conversation.id }}">
              <svg class="bi me-2" width="16" height="16" fill="currentColor">
                <use xlink:href="#bell"/>
              </svg>Unmute notifications</button>
            </li>
          </ul>
        </div>
      </div>
      <!-- Chat Messages -->
      <div class="card-body" style="max-height: 400px; overflow-y: auto">
        <div class="chat-messages">
          {% for m in chat_messages %}
          <!-- Received Message -->
          <div class="mb-2 {% if m.sender == request.user %}d-flex justify-content-end{% endif %}">
            <div class="{% if m.sender == request.user %}bg-primary text-white{% else %}bg-body-secondary{% endif %} p-2 rounded" style="max-width: 70%">
              <small class="{% if m.sender == request.user %}text-white{% else %}text-muted{% endif %}">{{ m.sender.username }} â€¢ {{ m.timestamp|time }}
                {% if m.is_read %}
                <svg class="bi" width="16" height="16" fill="currentColor">
                  <use xlink:href="#check2-all"></use>
                </svg>
                {% endif %}
              </small>
              <p class="mb-0">{{ m.content }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <!-- Message Input -->
      <div class="card-footer">
        <form class="d-flex" method="post">
          {% csrf_token %}
          {{ form.content }}
          <button type="submit" class="btn btn-primary">
            <svg class="bi" width="16" height="16" fill="currentColor">
              <use xlink:href="#send"></use>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
  </div>
</div>
{% endblock %}
